//   MMMMMMMMMMMMMMMMMMMMNMMMMMMNMMMMNNMNDNNN$77??++I??II7$8DMMMMMMMMMMMMMMMMMMMMM..
//   MMMMMMMMMMNNNMMMMMMMNMM8MMMMMMMNMMMMNNNZ$III88?+==+I7$MMMMMDMMMMMMMMMMMMMMMMM..
//  .MMMMMMMMMMNNNNMMMMMNNNMMMMMMMMMMMMDNNDZIIZ$Z$77++I8888MMMMMMMMMMMMMMMMMMMMMMM..
//   MMMMMMMMMMMNNNNMMMMNNNNMMMMMMMMMMMZNMZ7II???I?7?7=DODZNDMMMMMMMMMMMMMMMMMMMMM..
//   MMMMMMMMMMMNNNNNNNMNNNNMNMMMMMMMMMDOMZ7I?++??7I?$?I$ZZDDMMMMMMMMMMMMMMMMMMMMM..
//  .MMMMMMMMMMMMMNNMMMMMNDNMONMMMMMMMMD7MOI?I?==I7I?$II?7DNMMMMMMMMMMMMMMMMMMMMMM..
//  .MMMMMMMMMMMMMMMMMMMMMMNMZMMMMMMMMMMMMOI??+++?77?$II7ZMMMMMMMMMMMMMMMMMMMMMMMM..
//  .NMMMMMMMMMMMMMMMMMM8MMMNZ8MMMMMMMMMMMO77I7$$7$7O7I7$NMMMMMMMMMMMMMMMMMMMMMMMM..
//  .NMMMMMMMMMMMMMMMM$...8MNOOMMMMMMMNNMMNZ$7~?7$$77O$$NMMMMMMMMMMMMMMMMMMMMMMMMM..
//  .NMMMMMMMMMMMMMMO......=~NO8MMMMMMMDMMN$7I$$$=7I$$ZDMMMMMMMMMMMMMMMMMMMMMMMMMM..
//   MMMMMMMMMDDNN$.........==IMMMMMMMMMM877+?+=++I=7ZNMMMMMMMMMMMMMMMMMMMMMMMMMMM..
//   MMMMMMMNN888.............~~8MMMNMMMM$I+??I=~7$IZNMMMMMMMMMMMMMMMMMMMMMMMMMMMM..
//   MMMMMMMMNND?I...............ZMMMNNDZ7?++$O$77$OMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM..
//  .MMMMMMMMNN7III................D8ZDDZI?+++?IZN8$NMMMMMMMMMMMMMMMMMMMMMMMMMMMMM..
//   MMMMMMNDDIIIII?I..............:OZDDD8?++++??77Z88OOMMMMMMMMMMMMMMMMMMMMMMMMMM..
//  .MMMMMDOOZII?I777I+...............DDDDDZ+++??I7$Z$8NOOMMMMMMMMMMMMMMMMMMMMMMMM..
//  .MMMM::?ZZZ7$$$7????...............?DDD88$?+??I$$$8DNZZ8NMMMMMMMMMMMMMMMMMMMMM..
//   MM?:::,~$Z7??I?I????=...~..........?+$DDDD8?++I7$DDNNZO888MMMMMMMMMMMMMMMMMMM..
//  .M~~~:,,,~ZZII?II????=I..+:,......=~=+.ID778DDZNDDDDDNOO8ZO8DMMMMMMMMMMMMMMMMM..
//  .:??,:,:,,~ZZ7???????7=I?=~=.....~::=..,=+888DDNDDDDNDDZ$8ZZONMMMMMMMMMMMMMMMM..
//  .==+I?:,,,~:~Z77?=?~?7=7I::~....~,,~..=~+:IODDDNDDDDDDN$ZZ$DO8MMMMMMMMMMMMMMMM..
//   DNN~~??~::::~$7~:==?+7~+,:+..~~:::=~,:~.++,DD8NDDDDDDDZZZ$ZZOMMMMMNMMMMMMMMMM..
//  .NNNNNO+:~=~:..=+I:+=7?I~,:~::::,,,:::~=~++.8DDNDDDDDDD$$Z$ZZOMMMMMNMMMMMMMMMM..
//  .NNNNNN$~~:=~:...$:?~=?I+::::,,,,,:~~:,,=7.+IDDNDDDDDDD8ZZ$ZZDNMMMMMMMMMMMMMMM. 
//   NNMNNND++~=~:....I??+77I~:::::,,::,:,:?I=~+.8DNDDDDDDD8ZZ$$OOMMMMMMMMMMMMMMMM. 
//  .MMMMMMMM$+:,==~,...II$I?~:~~,::=:~~~=:,~?,..D8DDDDDDDD8$OZ$OOMMMMMMMMMMMMMMMM. 
//  .MNNNNNNNMM7::.,:~,.,+$$Z7~~?~::~,::==+~::..IDDDDDDDDDDZZ$OZZ8MMMMMMMMMMMMMMMM. 
//  .MNNNNMMNMMM7:,......I777I?=:=~:~:~~?~~~...DDDDDDDDDDDDOO$7OZDMMMMMMMMMMMMMMMM. 
//  .MNNNNMMNMMMM?+~,..=77I+OO?$$=:~~+I::....DDDDDDDDDDDDNNZZOZZZ8MMMMMMMMMMMMMMMM. 
//  .MNNNNNNMMMMMMI~:,=I7+7III77I?I+77=....DD8DDDDDDDDDDD7DZ$OOO88NMMMMMMMMMMMMMMM. 
//  .MNNNNNNMMMMMNZ7..7?$$Z7?ZOO++?ZI+...?88DD888DDDDDD:,=~ZOZOOOONMMMMMMMMMMMMMMM. 
//  .MNMMNNMMMMMNOOZ$$Z?I77+$7?$?Z$?:,,ZD8DD8DDDDD8DDD..,:$Z8$ZZZZ8MMMMMMMMMMMMMMM. 
//  .MNNMNMMMMMMZO$Z$$7$?ZI$I$$I$7$Z,$+8DDDD88DD8DDD8...~~OOOOZ$8DNMMMMMMMMMMMMMMM. 
//  .NNMNNMMMMMMZ$I777II$Z$I7?$II7ZI$ZZDDDDDD8D88DDDO...?:DOZOZZ8ONMMMMMMMMMMMMMMM. 
//  .MMMMMMMMMMZ77$7$I7$$$77IZ$Z$O7I$$ZDDDD8DDDDDD8D=..,..+?I+$ZZZDMMMMMMMMMMMMMMM. 
//  .MMMMMMMMMOOZ$$$77ZI?I7OIZ$7=::,,:.,:7$ZO888DDD8+..:.~=+?IZ$O8DMMMMMMMMMMMMMMM. 
//   NMMNMMMMMOOZZ$Z$I?7$7ZZ$$?+,........,,$7$$I$=..~..:~:,.=Z7ZOO8MMMMMMMMMMMMMMM. 
//  .MMMMMMMMM$7O$$OZ$OZZZOI7ZO+~:......,,,,7777~,..~..:..,.::=~88MMMMMMMMMMMMMMMM. 
//  .MMNMMMNMM8Z$ZZZ7O$7ZOZOO$Z7$~.......,.:~Z$Z::.:=+~,,::~=~==,~=$NMMMMMMMM$77MM. 
//  .MMMMNNMMMM8OZOZZZOOZ8OMDO7ZZ+~:...,,...~$$$,..,.::~,+~~~:.,~==++=~~~=+??+?MMM  
//   NMMMMMMMMMM8OZOOOO8ONMM8$OZO:,.:~.......$$7....:....,:..,.~+,,~=????+==+?MMMM. 
//  .ONMMMMMMMMMMNOZODMNMNMMO$ZOZ....=.......+$...,,.,.....,,:.~+?+++++?+=ZMMMMMMM. 
//  .$8MMMMMMMMNMMMNNMMMMNMMOOZZO~...,~.....:7.,,:,...,........~~,,:~~~?NMMMMMMMMM. 
//   $ODMMMMMMMMNNNNMMMMMNNMOZZ88+,...,::,..,$?~~.....++I::~::....~~~IDMMMMMMMMMMM. 
//   ZZOMMMMMMMMMMMMMMMMMMMNZZOZO?~.,.,:,....??=:....:+??77777$O?7OMNMNMMMMMMMMMMM. 
//  .Z$O8MMMMMMMMMMMMMMMMNNNZZOOZZ+:,,:,,::.:$7:..,..,..?IIIZ8DMMMMMMMMMMMMMMMMMMM. 
//   $ZO8MMMMMMMMMMMMMMMNMMDO$OZO$I=+:::,..,,$?:,......,.8DN8D8MMMMMMMMMMMMMMMMMMM. 
//  .$ZZ8MMMMMMMMMMMMMMMMNNDZODZO$I?+~,,,:,,:Z~O~......:.:8M8DDDMMMMMMMMMMMMMMMMMM. 
//  ........................................................................        
//  ..~~.~~=.=?:=.?.=.+...:...=.O.Z..  7.$ .,....,,~ =..:.=I.,..,.,I..$.=~.~.       
//  ..~~.ZZ:ZZ:.I.~.Z.I:.ZZ$.?I .,.$. .7$ .O7$ZOOIZ~7,..=+.I +$Z..,,.....~:.        

/** INSTAGRAM APP **/
InstagramApp.prototype = App.prototype;

function InstagramApp () {
  App.call(this);
}

~function () {
  // *-property

  var app = { width : 800, height : 800 };
  var _container;
  var _canvas;
  var _socket;
  var cc;
  var base = new Image(), blend = new Image();

  base.onload = __draw;

  // Public stock

  /**
   * Initialize InstagramApp
   * Creates CANVAS element and appends it to #div-bg, and adds a websocket
   * to the app.
   */
  InstagramApp.prototype.init = function () {
    base.src  = '/public/image/loading-1.png';
    blend.src = '/public/image/loading-2.png';

    _container = document.getElementById('div-bg');
    _canvas = document.createElement('CANVAS');
    _canvas.width  = app.width;
    _canvas.height = app.height;
    cc = _canvas.getContext('2d');
    _container.appendChild(_canvas);

    _socket = io.connect('http://poolvvater.jit.su:80');
    _socket.on('connect', function () {
      console.log('InstagramApp: connect');
    });
    _socket.on('new', function (obj) {
      console.log('InstagramApp: new');
      obj = JSON.parse(obj);
      var newest = obj.data[0];

      if (newest.type === 'image') {
        var images = newest.images;
        var img = new Image();
        img.src = images.low_resolution.url;
        img.onload = function () {
          if (Date.now() % 2) {
            // base = img;
          }
          else {
            // blend = img;
          }
        };

      }

      this.update();
      this.draw();
    });
  };

  InstagramApp.prototype.update = function () {
    console.log('InstagramApp: update');
  };

  InstagramApp.prototype.draw = function () {
    console.log('InstagramApp: draw');
    __draw();
  };

  InstagramApp.prototype.receive = function (fg, bg) {
  };

  function __draw () {
    _canvas.width = _canvas.width;
    // cc.drawImage(base, 0, 0, app.width, app.height);

    var x = -100;
    var y = -100;
    cc.rect(app.width, 0, 0, app.width, app.height);
    cc.fillStyle = '#000000';
    cc.fill();

    for (var i = 0, n = 10; i < n + 1; i++) {
      var x = i * app.width/n;
      var y = 0 - app.height/2;
      cc.lineStyle = '#FFFFFF';
      cc.lineWidth = app.width/n/2;
      cc.beginPath();
      cc.moveTo(x, y);
      cc.lineTo(x, 3/2*app.height);
      cc.stroke();
    }

    cc.globalCompositeOperation = 'source-in';
    cc.drawImage(base, 0, 0, app.width, app.height);

    for (var i = 0, n = 10; i < n + 1; i++) {
      var x = (i + .5) * app.width/n;
      var y = 0 - app.height/2;
      cc.lineStyle = '#FFFFFF';
      cc.lineWidth = app.width/n/2;
      cc.beginPath();
      cc.moveTo(x, y);
      cc.lineTo(x, 3/2*app.height);
      cc.stroke();
    }
    cc.globalCompositeOperation = 'source-in';
    cc.drawImage(blend, 0, 0, app.width, app.height);
  };
}();
